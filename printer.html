<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imprimantă NIIMBOT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

<div class="w-full max-w-md mx-auto bg-white rounded-2xl shadow-lg p-6">
    <div class="text-center">
        <h1 class="text-2xl font-bold text-gray-800">
            Imprimantă NIIMBOT <span class="text-sm font-normal text-green-500">v5</span>
        </h1>
        <p id="status" class="text-gray-500 mt-4 text-left bg-gray-100 p-3 rounded-lg">Apasă 'Conectează și Printează'</p>
    </div>

    <div class="mt-6">
        <label for="print-text-input" class="block text-sm font-medium text-gray-700">Text de imprimat:</label>
        <input type="text" id="print-text-input" value="Test v5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
        
        <button id="main-button" class="mt-4 w-full flex items-center justify-center gap-2 rounded-lg bg-blue-600 py-3 text-base font-bold text-white shadow-md hover:bg-blue-700">
            <span class="material-symbols-outlined">bluetooth</span>
            Conectează și Printează
        </button>
    </div>
</div>

<script>
// --- COD FINAL SIMPLIFICAT (v5) ---
const mainButton = document.getElementById('main-button');
const textInput = document.getElementById('print-text-input');
const statusP = document.getElementById('status');
let niimbotCharacteristic = null;

// --- ADRESELE BLUETOOTH FINALE ---
const SERVICE_UUID = '49535343-fe7d-4ae5-8fa9-9fafd205e455';
const CHARACTERISTIC_UUID_1 = '00002af1-0000-1000-8000-00805f9b34fb';
const CHARACTERISTIC_UUID_2 = '00002af0-0000-1000-8000-00805f9b34fb';
const CHARACTERISTIC_UUID_DE_FOLOSIT = CHARACTERISTIC_UUID_1; // Plan A

function createPacket(type, data) {
    const bytes = Array.isArray(data) ? data : [data];
    const checksum = bytes.reduce((acc, byte) => acc ^ byte, type ^ bytes.length);
    return new Uint8Array([0x55, 0x55, type, bytes.length, ...bytes, checksum, 0xAA, 0xAA]);
}

async function connectAndPrint() {
    try {
        if (!niimbotCharacteristic) {
            statusP.textContent = 'Pas 1: Căutare dispozitiv...';
            const device = await navigator.bluetooth.requestDevice({
                acceptAllDevices: true,
                optionalServices: [SERVICE_UUID]
            });

            statusP.textContent = 'Pas 2: Conectare la dispozitiv...';
            const server = await device.gatt.connect();

            statusP.textContent = 'Pas 3: Preluare serviciu...';
            const service = await server.getPrimaryService(SERVICE_UUID);

            statusP.textContent = 'Pas 4: Preluare caracteristică...';
            niimbotCharacteristic = await service.getCharacteristic(CHARACTERISTIC_UUID_DE_FOLOSIT);
            
            statusP.textContent = `Conectat la ${device.name}. Se printează...`;
        }

        const textToPrint = textInput.value;
        if (!textToPrint) {
            alert("Introduceți un text.");
            return;
        }

        statusP.textContent = 'Se pregătește eticheta...';
        const canvas = document.createElement('canvas');
        canvas.width = 240; canvas.height = 120;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = 'white'; ctx.fillRect(0, 0, 240, 120);
        ctx.fillStyle = 'black'; ctx.font = 'bold 60px Arial';
        ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        ctx.fillText(textToPrint, 120, 60);
        
        const imageData = ctx.getImageData(0, 0, 240, 120);
        const imagePackets = [];
        const widthInBytes = 240 / 8;
        for (let y = 0; y < 120; y++) {
            let lineBytes = new Uint8Array(widthInBytes);
            for (let x = 0; x < 240; x++) {
                const pixelValue = imageData.data[(y * 240 + x) * 4] < 128 ? 1 : 0;
                if (pixelValue === 1) lineBytes[Math.floor(x / 8)] |= (1 << (7 - (x % 8)));
            }
            const header = [(y >> 8) & 0xFF, y & 0xFF, 0, 0, 0, 1];
            imagePackets.push(createPacket(0x85, [...header, ...lineBytes]));
        }

        const delay = ms => new Promise(res => setTimeout(res, ms));
        await niimbotCharacteristic.writeValueWithoutResponse(createPacket(0x21, [3]));
        await niimbotCharacteristic.writeValueWithoutResponse(createPacket(0x23, [1]));
        await niimbotCharacteristic.writeValueWithoutResponse(createPacket(0x01, [1]));
        await niimbotCharacteristic.writeValueWithoutResponse(createPacket(0x03, [1]));
        const dim = [ (240 >> 8) & 0xFF, 240 & 0xFF, (120 >> 8) & 0xFF, 120 & 0xFF ];
        await niimbotCharacteristic.writeValueWithoutResponse(createPacket(0x13, dim));
        await niimbotCharacteristic.writeValueWithoutResponse(createPacket(0x15, [1, 0]));

        statusP.textContent = `Se transferă ${imagePackets.length} pachete...`;
        for (const packet of imagePackets) {
            await niimbotCharacteristic.writeValueWithoutResponse(packet);
            await delay(5);
        }
        await niimbotCharacteristic.writeValueWithoutResponse(createPacket(0xE3, [1]));
        await niimbotCharacteristic.writeValueWithoutResponse(createPacket(0xF3, [1]));
        
        statusP.textContent = 'Comandă trimisă cu succes!';

    } catch (error) {
        statusP.textContent = `EROARE: ${error.message}`;
        niimbotCharacteristic = null; // Resetează conexiunea la eroare
    }
}

mainButton.addEventListener('click', connectAndPrint);

</script>
</body>
</html>
